<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Funny Cupcake - Talkidz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.skypack.dev/@11labs/client"></script>
    <style>
        :root {
            --primary-color: #FF4B6E;
            --accent-color: #6C5CE7;
            --text-color: #1A1A1A;
            --background-color: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-color);
            margin: 0;
            overflow: hidden;
        }

        .gradient-text {
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .message-enter {
            opacity: 0;
            transform: translateY(20px);
        }

        .message-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }

        .background.image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-image: url('/api/placeholder/400/400');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.1;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        const { useState, useEffect, useCallback } = React;

        function AgentComponent() {
            const [messages, setMessages] = useState([]);
            const [isActive, setIsActive] = useState(false);
            const [progress, setProgress] = useState(0);
            const [currentMode, setCurrentMode] = useState('idle');
            const [conversation, setConversation] = useState(null);

            const CONVERSATION_TIME = 300;

            const addMessage = useCallback((text, isUser) => {
                setMessages(prev => [...prev, {
                    id: Date.now(),
                    text,
                    isUser,
                    timestamp: new Date().toISOString()
                }]);
            }, []);

            const triggerConfetti = () => {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.7 }
                });
            };

            const startConversation = async () => {
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    triggerConfetti();
                    setIsActive(true);
                    
                    const conv = await Conversation.startSession({
                        agentId: 'xiC8L3SOeHwYyCLLnYxF',
                        onModeChange: (mode) => setCurrentMode(mode.mode),
                        onMessage: (msg) => addMessage(msg.text, false),
                        onTranscript: (transcript) => {
                            if (transcript.text) {
                                addMessage(transcript.text, true);
                            }
                        }
                    });

                    setConversation(conv);
                    addMessage("Hi! I'm Funny Cupcake. What would you like to talk about?", false);

                } catch (error) {
                    console.error('Error:', error);
                    setIsActive(false);
                }
            };

            const endConversation = async () => {
                if (conversation) {
                    await conversation.endSession();
                    setConversation(null);
                }
                setIsActive(false);
                addMessage("Thanks for chatting! See you next time!", false);
            };

            useEffect(() => {
                let progressInterval;
                if (isActive) {
                    progressInterval = setInterval(() => {
                        setProgress(prev => {
                            if (prev >= 100) {
                                endConversation();
                                return 0;
                            }
                            return prev + (100 / CONVERSATION_TIME);
                        });
                    }, 1000);
                }
                return () => clearInterval(progressInterval);
            }, [isActive]);

            return (
                <div className="h-screen flex flex-col bg-white">
                    <div className="fixed top-0 left-0 right-0 h-16 px-6 flex items-center justify-between bg-white/90 backdrop-blur-md z-50 border-b">
                        <button className="p-2 hover:bg-gray-100 rounded-xl transition-colors">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 className="gradient-text text-xl font-bold">Funny Cupcake</h1>
                        <div className="w-10" />
                    </div>

                    <div className="relative flex-1 overflow-hidden">
                        <div className="background image floating" />
                        
                        <div className="absolute inset-0 overflow-y-auto pt-20 pb-40 px-4">
                            <div className="max-w-2xl mx-auto space-y-4">
                                {messages.map((msg) => (
                                    <div key={msg.id}
                                        className={`flex ${msg.isUser ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[80%] rounded-2xl px-4 py-2 ${
                                            msg.isUser 
                                                ? 'bg-gradient-to-r from-purple-600 to-pink-500 text-white' 
                                                : 'bg-gray-100 text-gray-800'
                                        }`}>
                                            <p className="text-sm">{msg.text}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md">
                        <div className="h-1 bg-gray-100">
                            <div className="h-full bg-gradient-to-r from-purple-600 to-pink-500 transition-all duration-1000"
                                style={{ width: `${progress}%` }} />
                        </div>
                        
                        <div className="px-6 py-4 flex items-center gap-4">
                            <button
                                onClick={isActive ? endConversation : startConversation}
                                className={`flex-1 max-w-xs mx-auto h-12 rounded-full font-medium transition-all
                                    ${isActive 
                                        ? 'bg-gray-200 hover:bg-gray-300 text-gray-800' 
                                        : 'bg-gradient-to-r from-purple-600 to-pink-500 hover:opacity-90 text-white'
                                    }`}>
                                {isActive ? (
                                    <svg className="mx-auto" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                ) : (
                                    <div className="flex items-center justify-center gap-2">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                                        </svg>
                                        <span>Start Conversation</span>
                                    </div>
                                )}
                            </button>
                            
                            <button 
                                onClick={() => {
                                    if (navigator.share) {
                                        navigator.share({
                                            title: 'Chat with Funny Cupcake',
                                            text: 'Come chat with your new AI friend!',
                                            url: window.location.href
                                        });
                                    }
                                }}
                                className="w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                                    <polyline points="16 6 12 2 8 6"/>
                                    <line x1="12" y1="2" x2="12" y2="15"/>
                                </svg>
                            </button>
                        </div>

                        <div className="px-6 py-3 border-t flex items-center justify-between">
                            <div>
                                <a href="/" className="gradient-text text-lg font-bold">Talkidz</a>
                                <p className="text-xs text-gray-500 ml-1">by Playbox</p>
                            </div>
                            <div className="text-sm text-gray-500">
                                {currentMode === 'listening' ? 'Listening...' : 
                                 currentMode === 'speaking' ? 'Speaking...' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(
            React.createElement(AgentComponent),
            document.getElementById('root')
        );
    </script>
</body>
</html>
