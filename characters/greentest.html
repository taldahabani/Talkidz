<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Green Screen Removal</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        canvas {
            max-width: 100%;
            max-height: 100vh;
        }
        #debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <video id="video" 
           src="character.mp4" 
           muted 
           autoplay 
           playsinline 
           webkit-playsinline
           loop 
           style="display:none;"></video>
    <canvas id="canvas"></canvas>
    <div id="debug"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const debug = document.getElementById('debug');

        // Configuration object for easy tweaking
        const config = {
            hueTarget: 120, // Green hue in HSV
            hueTolerance: 40, // How much hue can vary
            minSaturation: 30, // Minimum saturation for detection
            minBrightness: 30, // Minimum brightness for detection
            debugMode: false // Set to true to show debug info
        };

        // Convert RGB to HSV
        function rgbToHsv(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const diff = max - min;

            let h = 0;
            let s = max === 0 ? 0 : diff / max;
            let v = max;

            if (diff !== 0) {
                switch (max) {
                    case r:
                        h = 60 * ((g - b) / diff % 6);
                        break;
                    case g:
                        h = 60 * ((b - r) / diff + 2);
                        break;
                    case b:
                        h = 60 * ((r - g) / diff + 4);
                        break;
                }
            }

            if (h < 0) h += 360;

            return {
                h: h,
                s: s * 100,
                v: v * 100
            };
        }

        function isGreenScreen(r, g, b) {
            const hsv = rgbToHsv(r, g, b);
            
            // Check if the hue is in the green range
            let hueDiff = Math.abs(hsv.h - config.hueTarget);
            hueDiff = Math.min(hueDiff, 360 - hueDiff); // Handle hue wrapping
            
            return hueDiff < config.hueTolerance && 
                   hsv.s > config.minSaturation && 
                   hsv.v > config.minBrightness;
        }

        function setupVideo() {
            video.addEventListener('loadeddata', () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                drawFrame();
            });

            video.addEventListener('canplay', () => {
                video.play().catch(err => {
                    console.log("Auto-play not allowed:", err);
                });
            });
        }

        function drawFrame() {
            if (video.paused || video.ended) return;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;

            // Process each pixel
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                if (isGreenScreen(r, g, b)) {
                    data[i + 3] = 0; // Make pixel transparent
                }
            }

            ctx.putImageData(frame, 0, 0);
            
            if (config.debugMode) {
                debug.style.display = 'block';
                debug.textContent = `Video Size: ${video.videoWidth}x${video.videoHeight}
                                   Canvas Size: ${canvas.width}x${canvas.height}
                                   FPS: ${(1000 / (performance.now() - lastFrame)).toFixed(1)}`;
                lastFrame = performance.now();
            }

            requestAnimationFrame(drawFrame);
        }

        // Handle mobile autoplay
        document.body.addEventListener('click', () => {
            if (video.paused) {
                video.play().catch(console.error);
            }
        });

        // Initialize
        let lastFrame = performance.now();
        setupVideo();
    </script>
</body>
</html>
